<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 특허 명세서 초안 생성기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .patent-output h2, .advanced-output h2 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 700; /* font-bold */
            margin-top: 1.5rem; /* mt-6 */
            margin-bottom: 0.5rem; /* mb-2 */
            padding-bottom: 0.5rem; /* pb-2 */
            border-bottom: 2px solid #e5e7eb; /* border-gray-200 */
        }
        .patent-output h3 {
            font-size: 1rem; /* text-base */
            font-weight: 600; /* font-semibold */
            margin-top: 1rem; /* mt-4 */
            margin-bottom: 0.5rem; /* mb-2 */
            color: #4b5563; /* text-gray-600 */
        }
        .patent-output p, .advanced-output p, .advanced-output ul {
            text-align: justify;
            line-height: 1.75;
            margin-bottom: 1rem; /* mb-4 */
        }
        .advanced-output ul {
            list-style-position: inside;
            padding-left: 1rem;
        }
        .advanced-output li {
            margin-bottom: 0.5rem;
        }
        /* 로딩 스피너 애니메이션 */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        .form-error {
            color: #ef4444; /* text-red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.5rem; /* mt-2 */
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-4xl px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">AI 특허 명세서 초안 생성기</h1>
            <p class="text-md text-gray-600 mt-2">아이디어를 입력하면 AI가 특허 명세서 초안을 자동으로 작성해 드립니다.</p>
        </header>

        <main class="bg-white p-8 rounded-xl shadow-lg">
            <div class="space-y-6">
                <div>
                    <label for="invention-title" class="block text-sm font-medium text-gray-700 mb-1">발명의 명칭 (희망)</label>
                    <input type="text" id="invention-title" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="예: 소음 제거 기능이 있는 스마트 베개">
                </div>
                <div>
                    <label for="problem-to-solve" class="block text-sm font-medium text-gray-700 mb-1">해결하려는 문제점 (어떤 불편함이 있나요?)</label>
                    <textarea id="problem-to-solve" rows="4" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="예: 주변 소음 때문에 숙면을 취하기 어렵습니다. 기존 귀마개는 불편하고 장시간 사용 시 귀에 통증을 유발합니다."></textarea>
                </div>
                <div>
                    <label for="solution" class="block text-sm font-medium text-gray-700 mb-1">아이디어의 핵심 해결 방안 (어떻게 해결하나요?)</label>
                    <textarea id="solution" rows="4" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="예: 베개 내부에 소음 감지 센서와 역位相 소음을 발생시키는 스피커를 내장합니다. 사용자의 수면 패턴을 분석하여 최적의 소음 제거 알고리즘을 적용합니다."></textarea>
                </div>
            </div>
            <div id="form-error" class="form-error hidden"></div>

            <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                <button id="refine-idea-button" class="w-full sm:w-auto bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-400 transition duration-300">
                    ✨ 아이디어 구체화
                </button>
                <button id="generate-button" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out transform hover:scale-105">
                    명세서 초안 생성하기
                </button>
            </div>

            <!-- 결과 표시 영역 -->
            <div id="result-container" class="mt-10 border-t pt-6 hidden">
                 <div id="loading-indicator" class="flex justify-center items-center my-10 hidden">
                    <div class="spinner"></div>
                    <p class="ml-4 text-gray-600">AI가 명세서를 작성 중입니다. 잠시만 기다려주세요...</p>
                </div>
                <div id="patent-output-wrapper">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-2xl font-bold">생성된 특허 명세서 초안</h2>
                         <button id="copy-button" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">
                             본문 복사
                         </button>
                    </div>
                    <div id="patent-output" class="patent-output bg-gray-50 p-6 rounded-lg border">
                        <!-- AI 생성 결과가 여기에 표시됩니다. -->
                    </div>
                </div>

                <!-- 고급 AI 기능 -->
                <div id="advanced-tools" class="mt-8 border-t pt-6">
                    <h2 class="text-xl font-bold text-center mb-4">✨ 추가 AI 분석 도구</h2>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                        <button id="expand-claims-button" class="w-full sm:w-auto bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition">✨ 청구항 확장</button>
                        <button id="suggest-keywords-button" class="w-full sm:w-auto bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">✨ 선행 기술 검색어 추천</button>
                    </div>
                    <div id="advanced-loading-indicator" class="flex justify-center items-center my-6 hidden">
                        <div class="spinner"></div>
                        <p class="ml-4 text-gray-600">AI가 분석 중입니다...</p>
                    </div>
                    <div id="advanced-results-container" class="mt-6 advanced-output"></div>
                </div>

                 <div id="error-message" class="text-red-500 mt-4 hidden text-center"></div>
            </div>
        </main>
    </div>

    <script>
        // DOM Elements
        const inventionTitle = document.getElementById('invention-title');
        const problemToSolve = document.getElementById('problem-to-solve');
        const solution = document.getElementById('solution');
        const formError = document.getElementById('form-error');

        const generateButton = document.getElementById('generate-button');
        const refineIdeaButton = document.getElementById('refine-idea-button');
        const expandClaimsButton = document.getElementById('expand-claims-button');
        const suggestKeywordsButton = document.getElementById('suggest-keywords-button');

        const resultContainer = document.getElementById('result-container');
        const patentOutputWrapper = document.getElementById('patent-output-wrapper');
        const patentOutput = document.getElementById('patent-output');
        const copyButton = document.getElementById('copy-button');
        
        const loadingIndicator = document.getElementById('loading-indicator');
        const advancedLoadingIndicator = document.getElementById('advanced-loading-indicator');
        const advancedResultsContainer = document.getElementById('advanced-results-container');
        const errorMessage = document.getElementById('error-message');

        let fullSpecificationText = ''; // 전체 명세서 텍스트 저장

        // Utility Functions
        function validateInputs() {
            if (!inventionTitle.value || !problemToSolve.value || !solution.value) {
                formError.textContent = '모든 입력 필드를 채워주세요.';
                formError.classList.remove('hidden');
                return false;
            }
            formError.classList.add('hidden');
            return true;
        }

        function showLoading(isLoading, isAdvanced = false) {
            const loader = isAdvanced ? advancedLoadingIndicator : loadingIndicator;
            if (isLoading) {
                loader.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                if (!isAdvanced) {
                   resultContainer.classList.remove('hidden');
                   patentOutputWrapper.classList.add('hidden');
                   document.getElementById('advanced-tools').classList.add('hidden');
                }
            } else {
                loader.classList.add('hidden');
            }
        }
        
        // Event Listeners
        refineIdeaButton.addEventListener('click', async () => {
            if (!validateInputs()) return;

            showLoading(true, true);
            advancedResultsContainer.innerHTML = '';
            
            const systemPrompt = `You are an expert innovation consultant. Your task is to refine a user's raw idea into a more concrete and technologically rich concept. Respond in a clean JSON format with three keys: "title", "problem", and "solution". The content should be in Korean.`;
            const userPrompt = `Please refine the following idea. Make the title, problem, and solution more professional and detailed.\n\n- Title: ${inventionTitle.value}\n- Problem: ${problemToSolve.value}\n- Solution: ${solution.value}\n\nReturn the response ONLY as a JSON object like {"title": "...", "problem": "...", "solution": "..."}.`;

            try {
                const jsonString = await callGeminiAPIWithRetry(systemPrompt, userPrompt);
                // AI 응답이 마크다운 코드 블록으로 감싸여 오는 경우를 처리
                const jsonMatch = jsonString.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const refinedIdea = JSON.parse(jsonMatch[0]);
                    inventionTitle.value = refinedIdea.title;
                    problemToSolve.value = refinedIdea.problem;
                    solution.value = refinedIdea.solution;
                } else {
                    throw new Error("AI가 유효한 JSON 형식을 반환하지 않았습니다.");
                }
            } catch (error) {
                 handleError(error);
            } finally {
                showLoading(false, true);
            }
        });

        generateButton.addEventListener('click', async () => {
            if (!validateInputs()) return;
            
            showLoading(true);
            
            const systemPrompt = `You are a top-tier patent attorney, formerly a patent examiner in the Korean Intellectual Property Office. Based on the user's idea, you must draft a detailed and logical patent specification draft following the standard format and terminology of Korean patent law. Do not just repeat the idea; elaborate on the technical principles, expected effects, and possible embodiments. The final output must be plain text with section titles and content, without any HTML tags.`;
            const userPrompt = `Draft a patent specification based on the following idea. Please include all the sections below and write each section richly and professionally:\n\n- Invention Title (Desired): ${inventionTitle.value}\n- Problem to Solve: ${problemToSolve.value}\n- Core Solution: ${solution.value}\n\nSections to include:\n1. 【발명의 명칭】\n2. 【기술분야】\n3. 【배경기술】\n4. 【발명의 내용】 (with sub-sections for 과제, 해결 수단, 효과)\n5. 【청구범위】 (Write one detailed main claim as 청구항 1)\n6. 【요약】`;

            try {
                const generatedText = await callGeminiAPIWithRetry(systemPrompt, userPrompt);
                fullSpecificationText = generatedText; // Save for later use
                displayResult(generatedText);
                patentOutputWrapper.classList.remove('hidden');
                document.getElementById('advanced-tools').classList.remove('hidden');
            } catch (error) {
                handleError(error);
            } finally {
                showLoading(false);
            }
        });

        expandClaimsButton.addEventListener('click', async () => {
            if (!fullSpecificationText) return;
            showLoading(true, true);
            advancedResultsContainer.innerHTML = '';

            const systemPrompt = `You are a top-tier patent attorney specializing in claim drafting. Based on the provided main claim (Claim 1), your task is to draft several dependent claims (Claims 2, 3, 4, etc.) that specify and narrow the scope of the main claim, thereby strengthening the patent.`;
            const userPrompt = `Based on the following patent draft, especially Claim 1 in the "【청구범위】" section, please write detailed dependent claims (e.g., 청구항 2, 청구항 3, 청구항 4). Each dependent claim must further detail or limit an element of Claim 1.\n\n---Original Draft---\n${fullSpecificationText}`;
            
            try {
                const generatedText = await callGeminiAPIWithRetry(systemPrompt, userPrompt);
                displayAdvancedResult('확장된 청구항', generatedText);
            } catch (error) {
                handleError(error);
            } finally {
                showLoading(false, true);
            }
        });

        suggestKeywordsButton.addEventListener('click', async () => {
            if (!validateInputs()) return;
            showLoading(true, true);
            advancedResultsContainer.innerHTML = '';
            
            const systemPrompt = `You are a patent search specialist expert in prior art searches. Analyze the user's invention idea and recommend the most relevant search keywords and classification codes.`;
            const userPrompt = `For the following invention idea, please recommend search keywords for a prior art search. Provide a list of Korean keywords, English keywords, and relevant CPC (Cooperative Patent Classification) codes if possible.\n\n---Invention Idea---\nTitle: ${inventionTitle.value}\nProblem: ${problemToSolve.value}\nSolution: ${solution.value}`;

            try {
                const generatedText = await callGeminiAPIWithRetry(systemPrompt, userPrompt);
                displayAdvancedResult('선행 기술 조사를 위한 추천 검색어', generatedText);
            } catch (error) {
                handleError(error);
            } finally {
                showLoading(false, true);
            }
        });

        copyButton.addEventListener('click', () => {
            const textToCopy = patentOutput.innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('명세서 내용이 클립보드에 복사되었습니다.');
            }).catch(err => {
                console.error('클립보드 복사 실패:', err);
                alert('복사에 실패했습니다.');
            });
        });
        
        // Core API Call Function
        async function callGeminiAPIWithRetry(systemPrompt, userPrompt, retries = 3, delay = 1000) {
            const apiKey = "AIzaSyD0tucVqEXEq2gvr0VTbQzVBYQqlQVa-Ko"; // API key is inserted here.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { temperature: 0.6, topP: 0.9, topK: 40 }
            };
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid API response structure.");
                    }
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }

        // Display Functions
        function handleError(error) {
            console.error('Error:', error);
            errorMessage.textContent = `오류가 발생했습니다: ${error.message}`;
            errorMessage.classList.remove('hidden');
        }
        
        function formatTextToHtml(text) {
            return text.split('\n').map(line => {
                line = line.trim();
                if (line.startsWith('【') && line.endsWith('】')) {
                    if (line.includes('과제') || line.includes('수단') || line.includes('효과')) {
                        return `<h3>${line}</h3>`;
                    }
                    return `<h2>${line}</h2>`;
                } else if (line.toLowerCase().includes('korean keywords') || line.toLowerCase().includes('english keywords') || line.includes('CPC')) {
                    return `<h3>${line}</h3>`;
                } else if (line.startsWith('-') || line.match(/^\d+\./)) {
                    return `<ul><li>${line.substring(line.indexOf(' ')+1)}</li></ul>`;
                } else if (line) {
                    return `<p>${line}</p>`;
                }
                return '';
            }).join('');
        }

        function displayResult(text) {
            patentOutput.innerHTML = formatTextToHtml(text);
        }

        function displayAdvancedResult(title, text) {
            advancedResultsContainer.innerHTML = `
                <div class="bg-gray-50 p-6 rounded-lg border">
                    <h2 class="text-xl font-bold mb-4">${title}</h2>
                    ${formatTextToHtml(text).replace(/<h2>/g, '<h3>')}
                </div>
            `;
        }
    </script>
</body>
</html>

